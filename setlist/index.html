<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setlist App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #333; /* Darker track for dark theme */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #666; /* Darker thumb for dark theme */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        /* Style for collapsed comments */
        .comments-list-container.collapsed {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .comments-list-container:not(.collapsed) {
            max-height: 500px; /* Arbitrary max-height for smooth transition */
            transition: max-height 0.5s ease-in;
        }
        /* Initial icon styling */
        .initial-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px; /* Small size for initials */
            height: 24px;
            border-radius: 50%;
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* font-medium */
            color: white;
            flex-shrink: 0; /* Prevent shrinking */
        }
        /* Style for the add comment section when collapsed */
        .add-comment-section.collapsed {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center p-4 sm:p-6 text-gray-100">
    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg w-full max-w-md md:max-w-2xl lg:max-w-4xl">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-white mb-5">Setlist</h1>
        <p class="text-center text-gray-300 mb-6 text-sm">
            Add new songs, then vote on your favorites!
            <span id="auth-status">
                Your user is: <span id="user-id" class="font-semibold text-blue-400">Not signed in</span>
                <button id="editDisplayNameBtn" class="ml-2 bg-gray-600 text-white p-1 rounded-md hover:bg-gray-700 transition duration-300 ease-in-out shadow-sm text-sm hidden">
                    ‚öôÔ∏è
                </button>
            </span>
            <button id="logoutBtn" class="ml-4 bg-gray-600 text-white py-1 px-3 rounded-md hover:bg-gray-700 transition duration-300 ease-in-out shadow-sm text-sm hidden">
                Logout
            </button>
        </p>

        <div id="authSection" class="text-center mb-6">
            <p class="text-gray-300 mb-3 text-sm">Please sign in to add songs and vote:</p>
            <button id="signInWithGoogleBtn" class="bg-blue-600 text-white py-2 px-5 rounded-md hover:bg-blue-700 transition duration-300 ease-in-out shadow-md flex items-center justify-center mx-auto text-base">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.24 10.27c.33 0 .65.03.96.08 1.48-.96 2.49-2.73 2.49-4.8 0-3.3-2.69-5.99-5.99-5.99-3.3 0-5.99 2.69-5.99 5.99 0 3.1 2.36 5.67 5.4 5.94v-2.06c-1.34-.27-2.35-1.5-2.35-3.08 0-1.7 1.39-3.09 3.09-3.09 1.7 0 3.09 1.39 3.09 3.09 0 1.58-1.01 2.81-2.35 3.08v2.06c3.04-.27 5.4-2.84 5.4-5.94 0-3.3-2.69-5.99-5.99-5.99z" fill="#EA4335"/>
                    <path d="M12.24 10.27c-.33 0-.65-.03-.96-.08-1.48.96-2.49 2.73-2.49 4.8 0 3.3 2.69 5.99 5.99 5.99 3.3 0 5.99-2.69 5.99-5.99 0-3.1-2.36-5.67-5.4-5.94v2.06c1.34.27 2.35 1.5 2.35 3.08 0 1.7-1.39 3.09-3.09 3.09-1.7 0-3.09-1.39-3.09-3.09 0-1.58 1.01-2.81 2.35-3.08z" fill="#FBBC04"/>
                    <path d="M12.24 10.27c-.33 0-.65-.03-.96-.08-1.48.96-2.49 2.73-2.49 4.8 0 3.3 2.69 5.99 5.99 5.99 3.3 0 5.99-2.69 5.99-5.99 0-3.1-2.36-5.67-5.4-5.94v2.06c1.34.27 2.35 1.5 2.35 3.08 0 1.7-1.39 3.09-3.09 3.09-1.7 0-3.09-1.39-3.09-3.09 0-1.58 1.01-2.81 2.35-3.08z" fill="#4285F4"/>
                    <path d="M12.24 10.27c-.33 0-.65-.03-.96-.08-1.48.96-2.49 2.73-2.49 4.8 0 3.3 2.69 5.99 5.99 5.99 3.3 0 5.99-2.69 5.99-5.99 0-3.1-2.36-5.67-5.4-5.94v2.06c1.34.27 2.35 1.5 2.35 3.08 0 1.7-1.39 3.09-3.09 3.09-1.7 0-3.09-1.39-3.09-3.09 0-1.58 1.01-2.81 2.35-3.08z" fill="#34A853"/>
                </svg>
                Sign in with Google
            </button>
        </div>

        <div id="appContent" class="hidden">
            <div class="mb-5 p-4 bg-gray-700 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold text-white mb-3">Add New Song</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                    <div>
                        <label for="proposalTitle" class="block text-xs font-medium text-gray-300 mb-1">Title</label>
                        <input type="text" id="proposalTitle" placeholder="e.g., Bohemian Rhapsody" class="w-full p-2 text-sm border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-900 text-white">
                    </div>
                    <div>
                        <label for="proposalDescription" class="block text-xs font-medium text-gray-300 mb-1">Artist/Description</label>
                        <input type="text" id="proposalDescription" placeholder="e.g., Queen (Classic Rock)" class="w-full p-2 text-sm border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-900 text-white">
                    </div>
                    <div class="md:col-span-2">
                        <label for="proposalLink" class="block text-xs font-medium text-gray-300 mb-1">YouTube/Spotify Link (Optional)</label>
                        <input type="url" id="proposalLink" placeholder="e.g., https://www.youtube.com/watch?v=fJ9rUzIMcZQ" class="w-full p-2 text-sm border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-900 text-white">
                    </div>
                </div>
                <button id="addProposalBtn" class="w-full bg-blue-600 text-white py-2 px-5 rounded-md hover:bg-blue-700 transition duration-300 ease-in-out shadow-md text-base">
                    Add Song
                </button>
            </div>

            <div class="mb-5 p-4 bg-gray-700 rounded-lg shadow-inner">
                <label for="searchInput" class="block text-xs font-medium text-gray-300 mb-1">Search Songs</label>
                <input type="text" id="searchInput" placeholder="Search by title or artist..." class="w-full p-2 text-sm border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-900 text-white">
            </div>

            <div>
                <h2 class="text-xl font-semibold text-white mb-3">Current Songs</h2>
                <div id="proposalsList" class="space-y-3">
                    <p id="loadingMessage" class="text-center text-gray-400 text-sm">Loading songs...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center text-gray-100">
            <p id="messageText" class="text-lg font-semibold mb-4"></p>
            <button id="messageBoxCloseBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">
                OK
            </button>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg w-full max-w-md text-gray-100">
            <h2 class="text-2xl font-semibold text-white mb-4">Edit Song</h2>
            <input type="hidden" id="editProposalId">
            <div class="mb-4">
                <label for="editTitle" class="block text-sm font-medium text-gray-300 mb-1">Title</label>
                <input type="text" id="editTitle" class="w-full p-3 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-900 text-white">
            </div>
            <div class="mb-4">
                <label for="editDescription" class="block text-sm font-medium text-gray-300 mb-1">Artist/Description</label>
                <input type="text" id="editDescription" class="w-full p-3 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-900 text-white">
            </div>
            <div class="mb-6">
                <label for="editLink" class="block text-sm font-medium text-gray-300 mb-1">YouTube/Spotify Link (Optional)</label>
                <input type="url" id="editLink" class="w-full p-3 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-900 text-white">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelEditBtn" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition duration-300">Cancel</button>
                <button id="saveEditBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="editCommentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg w-full max-w-md text-gray-100">
            <h2 class="text-2xl font-semibold text-white mb-4">Edit Comment</h2>
            <input type="hidden" id="editCommentProposalId">
            <input type="hidden" id="editCommentId">
            <div class="mb-6">
                <label for="editCommentText" class="block text-sm font-medium text-gray-300 mb-1">Comment</label>
                <textarea id="editCommentText" class="w-full p-3 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-900 text-white resize-y min-h-[80px]"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelEditCommentBtn" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition duration-300">Cancel</button>
                <button id="saveEditCommentBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Display Name Modal -->
    <div id="editDisplayNameModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg w-full max-w-md text-gray-100">
            <h2 class="text-2xl font-semibold text-white mb-4">Edit Your Display Name</h2>
            <div class="mb-6">
                <label for="newDisplayNameInput" class="block text-sm font-medium text-gray-300 mb-1">New Display Name</label>
                <input type="text" id="newDisplayNameInput" class="w-full p-3 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-900 text-white" placeholder="Enter your preferred name">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelDisplayNameEditBtn" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition duration-300">Cancel</button>
                <button id="saveDisplayNameBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">Save Name</button>
            </div>
        </div>
    </div>


    <script type="module">
        console.log("Setlist App script started."); // Added log at the very beginning

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, arrayUnion, arrayRemove, deleteDoc, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Wrap everything in DOMContentLoaded to ensure elements are ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired. Script execution inside listener."); // Added log

            // Provided Firebase Configuration
            const firebaseConfig = {
                apiKey: "AIzaSyDLC0oIFYZ5tSSludYNO6eGO3LKpMno00I",
                authDomain: "siberini.firebaseapp.com",
                projectId: "siberini",
                storageBucket: "siberini.firebasestorage.app",
                messagingSenderId: "533139517303",
                appId: "1:533139517303:web:75e143e976c488ed596bb72",
                measurementId: "G-GG0NF9S621"
            };

            // Use the projectId as the base for the app-specific data path
            const appId = firebaseConfig.projectId;

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const googleProvider = new GoogleAuthProvider();
            console.log("Firebase app initialized."); // Added log

            let currentUserId = null; // To store the authenticated user's UID
            let currentUserDisplayName = null; // To store the authenticated user's display name
            let userProfilesCache = {}; // Cache for user display names from Firestore
            let commentListeners = {}; // Stores unsubscribe functions for comment subcollection listeners

            // Get DOM elements
            const proposalTitleInput = document.getElementById('proposalTitle');
            const proposalDescriptionInput = document.getElementById('proposalDescription');
            const proposalLinkInput = document.getElementById('proposalLink');
            const addProposalBtn = document.getElementById('addProposalBtn');
            const proposalsList = document.getElementById('proposalsList');
            const loadingMessage = document.getElementById('loadingMessage');
            const userIdDisplay = document.getElementById('user-id');
            const authSection = document.getElementById('authSection');
            const appContent = document.getElementById('appContent');
            const signInWithGoogleBtn = document.getElementById('signInWithGoogleBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const editDisplayNameBtn = document.getElementById('editDisplayNameBtn');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');
            const searchInput = document.getElementById('searchInput');

            // Edit Proposal Modal Elements
            const editModal = document.getElementById('editModal');
            const editProposalIdInput = document.getElementById('editProposalId');
            const editTitleInput = document.getElementById('editTitle');
            const editDescriptionInput = document.getElementById('editDescription');
            const editLinkInput = document.getElementById('editLink');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const saveEditBtn = document.getElementById('saveEditBtn');

            // Edit Comment Modal Elements
            const editCommentModal = document.getElementById('editCommentModal');
            const editCommentProposalIdInput = document.getElementById('editCommentProposalId');
            const editCommentIdInput = document.getElementById('editCommentId');
            const editCommentTextInput = document.getElementById('editCommentText');
            const cancelEditCommentBtn = document.getElementById('cancelEditCommentBtn');
            const saveEditCommentBtn = document.getElementById('saveEditCommentBtn');

            // Edit Display Name Modal Elements
            const editDisplayNameModal = document.getElementById('editDisplayNameModal');
            const newDisplayNameInput = document.getElementById('newDisplayNameInput');
            const cancelDisplayNameEditBtn = document.getElementById('cancelDisplayNameEditBtn');
            const saveDisplayNameBtn = document.getElementById('saveDisplayNameBtn');

            console.log("signInWithGoogleBtn element:", signInWithGoogleBtn); // Added log

            // Helper function to show custom message box
            function showMessageBox(message) {
                messageText.textContent = message;
                messageBox.classList.remove('hidden');
            }

            // Close message box
            messageBoxCloseBtn.addEventListener('click', () => {
                messageBox.classList.add('hidden');
            });

            // Helper function to generate initials from display name
            function getInitials(name) {
                if (!name) return '??';
                const parts = name.split(' ').filter(n => n.length > 0);
                if (parts.length === 1) {
                    return parts[0].substring(0, 2).toUpperCase();
                }
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }

            // Helper function to generate a consistent color based on user ID
            function hashCode(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                return hash;
            }

            function getColorFromUserId(userId) {
                const colors = [
                    '#EF4444', '#F97316', '#F59E0B', '#EAB308', '#84CC16', '#22C55E', '#10B981', '#06B6D4',
                    '#0EA5E9', '#3B82F6', '#6366F1', '#8B5CF6', '#A855F7', '#D946EF', '#EC4899', '#F43F5E'
                ];
                const index = Math.abs(hashCode(userId)) % colors.length;
                return colors[index];
            }

            // Function to update user profile in Firestore
            async function updateUserProfileInFirestore(user) {
                if (!user || !user.uid) return;

                const userRef = doc(db, `artifacts/${appId}/public/data/userProfiles`, user.uid);
                const currentDisplayName = user.displayName || `User ${user.uid.substring(0, 8)}...`;
                const currentPhotoURL = user.photoURL || null;

                try {
                    const userDoc = await getDoc(userRef);
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        if (data.displayName !== currentDisplayName || data.photoURL !== currentPhotoURL) {
                            await setDoc(userRef, {
                                displayName: currentDisplayName,
                                photoURL: currentPhotoURL,
                                lastUpdatedAt: new Date()
                            }, { merge: true });
                            console.log(`Updated user profile in Firestore for ${user.uid}`);
                        } else {
                            console.log(`User profile for ${user.uid} already up-to-date in Firestore.`);
                        }
                    } else {
                        await setDoc(userRef, {
                            uid: user.uid,
                            displayName: currentDisplayName,
                            photoURL: currentPhotoURL,
                            createdAt: new Date(),
                            lastUpdatedAt: new Date()
                        });
                        console.log(`Created user profile in Firestore for ${user.uid}`);
                    }
                } catch (error) {
                    console.error("Failed to write user profile to Firestore. Please check your Firestore security rules.", error);
                }
            }

            // Listen for real-time updates to user profiles
            function listenForUserProfiles() {
                const userProfilesColRef = collection(db, `artifacts/${appId}/public/data/userProfiles`);
                onSnapshot(userProfilesColRef, (snapshot) => {
                    userProfilesCache = {};
                    snapshot.docs.forEach(docSnapshot => {
                        userProfilesCache[docSnapshot.id] = docSnapshot.data();
                    });
                    console.log("User profiles cache updated:", userProfilesCache);
                    renderProposals(allProposals); // Re-render proposals to reflect updated display names
                }, (error) => {
                    console.error("Error listening to user profiles:", error);
                });
            }


            // Sign in with Google
            signInWithGoogleBtn.addEventListener('click', async () => {
                console.log("Sign-in button clicked. Attempting Google sign-in...");
                console.log("Firebase Config:", firebaseConfig);
                try {
                    const result = await signInWithPopup(auth, googleProvider);
                    console.log("Sign-in successful:", result.user);
                } catch (error) {
                    console.error("Google Sign-In error details:", error);
                    if (error.code === 'auth/popup-closed-by-user') {
                        showMessageBox("Sign-in cancelled. Please try again. (Check for popup blockers!)");
                    } else if (error.code === 'auth/unauthorized-domain') {
                        showMessageBox("Sign-in failed: The domain where this app is hosted is not authorized in your Firebase project. Please add this domain to 'Authorized domains' in Firebase Console > Authentication > Sign-in method.");
                    } else if (error.code === 'auth/network-request-failed') {
                        showMessageBox("Sign-in failed: Network error. Please check your internet connection.");
                    }
                    else {
                        showMessageBox(`Sign-in failed: ${error.message || "An unknown error occurred"}. Please check your browser's console for more details and ensure Google Sign-In is enabled in your Firebase project.`);
                    }
                }
            });

            // Logout
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    console.log("User signed out.");
                } catch (error) {
                    console.error("Error signing out:", error);
                    showMessageBox("Failed to log out. Please try again.");
                }
            });

            // Edit Display Name Button Click
            editDisplayNameBtn.addEventListener('click', () => {
                if (auth.currentUser) {
                    newDisplayNameInput.value = auth.currentUser.displayName || '';
                    editDisplayNameModal.classList.remove('hidden');
                } else {
                    showMessageBox("You must be signed in to change your display name.");
                }
            });

            // Cancel Edit Display Name
            cancelDisplayNameEditBtn.addEventListener('click', () => {
                editDisplayNameModal.classList.add('hidden');
            });

            // Save New Display Name
            saveDisplayNameBtn.addEventListener('click', async () => {
                const newName = newDisplayNameInput.value.trim();
                if (!newName) {
                    showMessageBox("Display name cannot be empty.");
                    return;
                }

                if (!auth.currentUser) {
                    showMessageBox("You must be signed in to change your display name.");
                    return;
                }

                try {
                    await updateProfile(auth.currentUser, {
                        displayName: newName
                    });
                    console.log("Firebase Auth profile updated successfully.");
                    editDisplayNameModal.classList.add('hidden');
                    showMessageBox("Your display name has been updated!");
                } catch (error) {
                    console.error("Error updating Firebase Auth profile:", error);
                    showMessageBox(`Failed to update display name: ${error.message}`);
                }
            });


            // Authenticate user
            onAuthStateChanged(auth, (user) => {
                console.log("onAuthStateChanged triggered. User object:", user);
                // Unsubscribe from all previous comment listeners on auth state change
                Object.values(commentListeners).forEach(unsubscribe => unsubscribe());
                commentListeners = {}; // Clear the map

                if (user) {
                    currentUserId = user.uid;
                    currentUserDisplayName = user.displayName || `User ${user.uid.substring(0, 8)}...`;

                    userIdDisplay.textContent = currentUserDisplayName;
                    authSection.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    logoutBtn.classList.remove('hidden');
                    editDisplayNameBtn.classList.remove('hidden');
                    console.log("Authenticated with UID:", currentUserId, "Display Name:", currentUserDisplayName);

                    updateUserProfileInFirestore(user); // Non-blocking update to Firestore profile
                    listenForUserProfiles();
                    listenForProposals();
                } else {
                    currentUserId = null;
                    currentUserDisplayName = null;
                    userProfilesCache = {};
                    userIdDisplay.textContent = "Not signed in";
                    authSection.classList.remove('hidden');
                    appContent.classList.add('hidden');
                    logoutBtn.classList.add('hidden');
                    editDisplayNameBtn.classList.add('hidden');
                    console.log("User is signed out.");
                    proposalsList.innerHTML = '<p class="text-center text-gray-400 text-sm">Please sign in to view and add songs.</p>';
                    loadingMessage.classList.add('hidden');
                }
            });

            // Add new song
            addProposalBtn.addEventListener('click', async () => {
                const title = proposalTitleInput.value.trim();
                const description = proposalDescriptionInput.value.trim();
                const link = proposalLinkInput.value.trim();

                if (!title || !description) {
                    showMessageBox("Please enter both a title and a description for the song.");
                    return;
                }

                if (!currentUserId) {
                    showMessageBox("You must be signed in to add a song.");
                    return;
                }

                try {
                    const initialUpvotes = [currentUserId];

                    await addDoc(collection(db, `artifacts/${appId}/public/data/proposals`), {
                        title: title,
                        description: description,
                        link: link,
                        upvotes: initialUpvotes,
                        downvotes: [],
                        createdAt: new Date(),
                        createdBy: currentUserId,
                        createdByDisplayName: currentUserDisplayName
                    });
                    proposalTitleInput.value = '';
                    proposalDescriptionInput.value = '';
                    proposalLinkInput.value = '';
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showMessageBox("Failed to add song. Please try again.");
                }
            });

            // Listen for real-time updates to songs
            let allProposals = [];

            function listenForProposals() {
                if (!currentUserId) {
                    console.warn("Attempted to listen for songs without a currentUserId.");
                    return;
                }

                const proposalsColRef = collection(db, `artifacts/${appId}/public/data/proposals`);
                const q = query(proposalsColRef, orderBy("createdAt", "desc"));

                onSnapshot(q, (snapshot) => {
                    allProposals = snapshot.docs.map(docSnapshot => ({
                        id: docSnapshot.id,
                        data: docSnapshot.data()
                    }));
                    renderProposals(allProposals);
                }, (error) => {
                    console.error("Error listening to songs:", error);
                    loadingMessage.textContent = "Error loading songs.";
                    showMessageBox("Failed to load songs. Please check your internet connection.");
                });
            }

            // Function to get display name from cache or fallback
            function getDisplayNameForUser(userId, fallbackDisplayNameFromProposal) {
                return userProfilesCache[userId]?.displayName || fallbackDisplayNameFromProposal || `User ${userId.substring(0, 8)}...`;
            }

            // Function to render comments for a specific proposal
            function renderComments(proposalId, commentsData) {
                const commentsListContainer = document.getElementById(`comments-list-${proposalId}`);
                if (!commentsListContainer) return;

                const addCommentSection = document.getElementById(`add-comment-section-${proposalId}`);
                const commentsCountSpan = commentsListContainer.previousElementSibling.querySelector('.toggle-comments');
                if (commentsCountSpan) {
                    commentsCountSpan.innerHTML = `üí¨ Comments (${commentsData.length}) <span class="toggle-icon">${commentsListContainer.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤'}</span>`;
                }

                let commentsHtml = '';
                if (commentsData.length > 0) {
                    commentsData.forEach(comment => {
                        commentsHtml += `
                            <div class="bg-gray-600 p-2 rounded-md mb-2 text-sm flex justify-between items-start">
                                <div>
                                    <p class="text-gray-200">${comment.text}</p>
                                    <p class="text-gray-400 text-xs mt-1">
                                        ‚Äî ${getDisplayNameForUser(comment.createdBy, comment.createdByDisplayName)}
                                        <span class="ml-2">${new Date(comment.createdAt.seconds * 1000).toLocaleString()}</span>
                                    </p>
                                </div>
                                ${comment.createdBy === currentUserId ? `
                                <div class="flex gap-1 ml-2">
                                    <button class="edit-comment-btn text-yellow-300 hover:text-yellow-400 text-xs p-1 rounded" data-proposal-id="${proposalId}" data-comment-id="${comment.id}" data-comment-text="${comment.text}">‚úèÔ∏è</button>
                                    <button class="delete-comment-btn text-red-300 hover:text-red-400 text-xs p-1 rounded" data-proposal-id="${proposalId}" data-comment-id="${comment.id}">üóëÔ∏è</button>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    });
                } else {
                    commentsHtml = '<p class="text-gray-400 text-sm">No comments yet.</p>';
                }

                const addCommentSectionHtml = addCommentSection ? addCommentSection.outerHTML : '';
                commentsListContainer.innerHTML = commentsHtml;
                if (addCommentSection) {
                    commentsListContainer.appendChild(addCommentSection);
                    if (commentsListContainer.classList.contains('collapsed')) {
                        addCommentSection.classList.add('collapsed');
                    } else {
                        addCommentSection.classList.remove('collapsed');
                    }
                }

                addEventListeners();
            }


            // Function to render songs based on current search query
            function renderProposals(proposalsToRender) {
                proposalsList.innerHTML = '';
                loadingMessage.classList.add('hidden');

                const searchTerm = searchInput.value.toLowerCase();
                const filteredProposals = proposalsToRender.filter(prop => {
                    const titleMatch = prop.data.title.toLowerCase().includes(searchTerm);
                    const descriptionMatch = prop.data.description.toLowerCase().includes(searchTerm);
                    return titleMatch || descriptionMatch;
                });

                if (filteredProposals.length === 0) {
                    proposalsList.innerHTML = '<p class="text-center text-gray-400 text-sm">No songs match your search.</p>';
                    return;
                }

                filteredProposals.forEach(prop => {
                    const proposal = prop.data;
                    const proposalId = prop.id;
                    const upvotes = proposal.upvotes || [];
                    const downvotes = proposal.downvotes || [];

                    const upvoteCount = upvotes.length;
                    const downvoteCount = downvotes.length;

                    const hasUpvoted = upvotes.includes(currentUserId);
                    const hasDownvoted = downvotes.includes(currentUserId);

                    const proposerName = getDisplayNameForUser(proposal.createdBy, proposal.createdByDisplayName);
                    const isOwner = proposal.createdBy === currentUserId;

                    const upvoterIcons = upvotes
                        .filter(voterId => typeof voterId === 'string' && voterId.length > 0)
                        .map(voterId => {
                            const displayName = getDisplayNameForUser(voterId, proposal.createdBy === voterId ? proposal.createdByDisplayName : null);
                            const initials = getInitials(displayName);
                            const bgColor = getColorFromUserId(voterId);
                            return `<span class="initial-icon" style="background-color:${bgColor};" title="${displayName}">${initials}</span>`;
                        }).join('');

                    const downvoterIcons = downvotes
                        .filter(voterId => typeof voterId === 'string' && voterId.length > 0)
                        .map(voterId => {
                            const displayName = getDisplayNameForUser(voterId, proposal.createdBy === voterId ? proposal.createdByDisplayName : null);
                            const initials = getInitials(displayName);
                            const bgColor = getColorFromUserId(voterId);
                            return `<span class="initial-icon" style="background-color:${bgColor};" title="${displayName}">${initials}</span>`;
                        }).join('');

                    const upvoterListHtml = upvotes.length > 0
                        ? `<div class="flex items-center flex-wrap gap-1 mt-1"><span class="text-xs text-gray-400 mr-1">Upvoted by:</span>${upvoterIcons}</div>`
                        : '';
                    const downvoterListHtml = downvotes.length > 0
                        ? `<div class="flex items-center flex-wrap gap-1 mt-1"><span class="text-xs text-gray-400 mr-1">Downvoted by:</span>${downvoterIcons}</div>`
                        : '';


                    const linkHtml = proposal.link
                        ? `<a href="${proposal.link}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline text-sm mt-1 block">Listen/View Link</a>`
                        : '';

                    const proposalDiv = document.createElement('div');
                    proposalDiv.className = 'bg-gray-700 p-3 rounded-lg shadow-md flex flex-col';
                    proposalDiv.innerHTML = `
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-2">
                            <div class="flex-grow mb-2 sm:mb-0">
                                <div class="flex flex-col sm:flex-row sm:items-baseline sm:gap-x-2">
                                    <h3 class="text-lg font-semibold text-white leading-tight">${proposal.title}</h3>
                                    <p class="text-gray-300 text-sm sm:text-base leading-tight mt-0 sm:mt-0">${proposal.description}</p>
                                </div>
                                ${linkHtml}
                                <p class="text-gray-400 text-xs mt-1 leading-tight">Proposed by: ${proposerName}</p>
                                ${upvoterListHtml}
                                ${downvoterListHtml}
                            </div>
                            <div class="flex items-center gap-2 mt-2 sm:mt-0">
                                <button class="vote-btn ${hasUpvoted ? 'bg-green-600' : 'bg-blue-600'} text-white p-2 rounded-md hover:bg-green-700 transition duration-300 ease-in-out shadow-sm text-sm flex items-center gap-1" data-id="${proposalId}" data-vote-type="up">
                                    ‚¨ÜÔ∏è ${upvoteCount}
                                </button>
                                <button class="vote-btn ${hasDownvoted ? 'bg-red-600' : 'bg-blue-600'} text-white p-2 rounded-md hover:bg-red-700 transition duration-300 ease-in-out shadow-sm text-sm flex items-center gap-1" data-id="${proposalId}" data-vote-type="down">
                                    ‚¨áÔ∏è ${downvoteCount}
                                </button>

                                ${isOwner ? `
                                <button class="edit-btn bg-yellow-600 text-white p-2 rounded-md hover:bg-yellow-700 transition duration-300 ease-in-out shadow-sm text-sm" data-id="${proposalId}" data-title="${proposal.title}" data-description="${proposal.description}" data-link="${proposal.link || ''}">
                                    ‚úèÔ∏è
                                </button>
                                <button class="delete-btn bg-red-600 text-white p-2 rounded-md hover:bg-red-700 transition duration-300 ease-in-out shadow-sm text-sm" data-id="${proposalId}">
                                    üóëÔ∏è
                                </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-600">
                            <h4 class="text-md font-semibold text-white mb-2 cursor-pointer toggle-comments" data-id="${proposalId}">
                                üí¨ Comments (0) <span class="toggle-icon">‚ñº</span>
                            </h4>
                            <div class="comments-list-container collapsed" id="comments-list-${proposalId}">
                                <!-- Comments will be dynamically loaded here by a separate listener -->
                                <p class="text-gray-400 text-sm">Loading comments...</p>
                                <div class="mt-3 flex gap-2 add-comment-section collapsed" id="add-comment-section-${proposalId}">
                                    <input type="text" placeholder="Add a comment..." class="add-comment-input w-full p-2 text-sm border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-900 text-white" data-id="${proposalId}">
                                    <button class="add-comment-btn bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-300 text-sm" data-id="${proposalId}">‚ûï</button>
                                </div>
                            </div>
                        </div>
                    `;
                    proposalsList.appendChild(proposalDiv);

                    // Set up real-time listener for comments of this specific proposal
                    const commentsColRef = collection(db, `artifacts/${appId}/public/data/proposals`, proposalId, 'comments');
                    const qComments = query(commentsColRef, orderBy("createdAt", "asc"));

                    // Unsubscribe from old listener if exists
                    if (commentListeners[proposalId]) {
                        commentListeners[proposalId]();
                    }

                    commentListeners[proposalId] = onSnapshot(qComments, (commentsSnapshot) => {
                        const commentsData = commentsSnapshot.docs.map(docSnapshot => ({
                            id: docSnapshot.id,
                            ...docSnapshot.data()
                        }));
                        renderComments(proposalId, commentsData);
                    }, (error) => {
                        console.error(`Error listening to comments for proposal ${proposalId}:`, error);
                        const commentsListContainer = document.getElementById(`comments-list-${proposalId}`);
                        if (commentsListContainer) {
                            commentsListContainer.innerHTML = '<p class="text-red-400 text-sm">Error loading comments.</p>';
                        }
                    });
                });

                addEventListeners();
            }

            function addEventListeners() {
                document.querySelectorAll('.vote-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const proposalId = event.currentTarget.dataset.id;
                        const voteType = event.currentTarget.dataset.voteType;
                        const proposalRef = doc(db, `artifacts/${appId}/public/data/proposals`, proposalId);

                        try {
                            const currentProposal = allProposals.find(p => p.id === proposalId);
                            if (!currentProposal) return;

                            let upvotes = [...(currentProposal.data.upvotes || [])];
                            let downvotes = [...(currentProposal.data.downvotes || [])];

                            if (!currentUserId) {
                                showMessageBox("You must be signed in to vote.");
                                return;
                            }

                            if (voteType === 'up') {
                                if (upvotes.includes(currentUserId)) {
                                    upvotes = upvotes.filter(uid => uid !== currentUserId);
                                } else {
                                    upvotes.push(currentUserId);
                                    downvotes = downvotes.filter(uid => uid !== currentUserId); // Remove downvote if present
                                }
                            } else if (voteType === 'down') {
                                if (downvotes.includes(currentUserId)) {
                                    downvotes = downvotes.filter(uid => uid !== currentUserId);
                                } else {
                                    downvotes.push(currentUserId);
                                    upvotes = upvotes.filter(uid => uid !== currentUserId); // Remove upvote if present
                                }
                            }

                            await updateDoc(proposalRef, {
                                upvotes: upvotes,
                                downvotes: downvotes
                            });
                        } catch (e) {
                            console.error("Error updating vote: ", e);
                            showMessageBox("Failed to cast vote. Please try again. Check Firebase rules for 'proposals' collection.");
                        }
                    };
                });

                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.onclick = (event) => {
                        const proposalId = event.currentTarget.dataset.id;
                        const title = event.currentTarget.dataset.title;
                        const description = event.currentTarget.dataset.description;
                        const link = event.currentTarget.dataset.link;

                        editProposalIdInput.value = proposalId;
                        editTitleInput.value = title;
                        editDescriptionInput.value = description;
                        editLinkInput.value = link;
                        editModal.classList.remove('hidden');
                    };
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const proposalId = event.currentTarget.dataset.id;
                        showMessageBox("Are you sure you want to delete this song? This action cannot be undone.");
                        document.getElementById('messageBoxCloseBtn').onclick = async () => {
                            try {
                                await deleteDoc(doc(db, `artifacts/${appId}/public/data/proposals`, proposalId));
                                messageBox.classList.add('hidden');
                            } catch (e) {
                                console.error("Error deleting document: ", e);
                                showMessageBox("Failed to delete song. Please try again. Check Firebase rules for 'proposals' collection.");
                            }
                            document.getElementById('messageBoxCloseBtn').onclick = () => messageBox.classList.add('hidden');
                        };
                    };
                });

                document.querySelectorAll('.add-comment-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const proposalId = event.currentTarget.dataset.id;
                        const commentInput = document.querySelector(`.add-comment-input[data-id="${proposalId}"]`);
                        const commentText = commentInput.value.trim();

                        if (!commentText) {
                            showMessageBox("Please enter a comment.");
                            return;
                        }

                        if (!currentUserId) {
                            showMessageBox("You must be signed in to add a comment.");
                            return;
                        }

                        try {
                            const commentsColRef = collection(db, `artifacts/${appId}/public/data/proposals`, proposalId, 'comments');
                            const newComment = {
                                text: commentText,
                                createdBy: currentUserId,
                                createdByDisplayName: currentUserDisplayName,
                                createdAt: new Date()
                            };
                            await addDoc(commentsColRef, newComment);
                            commentInput.value = '';
                        } catch (e) {
                            console.error("Error adding comment: ", e);
                            showMessageBox("Failed to add comment. Please try again. Check Firebase rules for comments subcollection.");
                        }
                    };
                });

                document.querySelectorAll('.toggle-comments').forEach(button => {
                    button.onclick = (event) => {
                        const proposalId = event.currentTarget.dataset.id;
                        const commentsListContainer = document.getElementById(`comments-list-${proposalId}`);
                        const addCommentSection = document.getElementById(`add-comment-section-${proposalId}`);
                        const toggleIcon = event.currentTarget.querySelector('.toggle-icon');

                        if (commentsListContainer.classList.contains('collapsed')) {
                            commentsListContainer.classList.remove('collapsed');
                            addCommentSection.classList.remove('collapsed');
                            toggleIcon.textContent = '‚ñ≤';
                        } else {
                            commentsListContainer.classList.add('collapsed');
                            addCommentSection.classList.add('collapsed');
                            toggleIcon.textContent = '‚ñº';
                        }
                    };
                });

                document.querySelectorAll('.edit-comment-btn').forEach(button => {
                    button.onclick = (event) => {
                        const proposalId = event.currentTarget.dataset.proposalId;
                        const commentId = event.currentTarget.dataset.commentId;
                        const commentText = event.currentTarget.dataset.commentText;

                        editCommentProposalIdInput.value = proposalId;
                        editCommentIdInput.value = commentId;
                        editCommentTextInput.value = commentText;
                        editCommentModal.classList.remove('hidden');
                    };
                });

                document.querySelectorAll('.delete-comment-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const proposalId = event.currentTarget.dataset.proposalId;
                        const commentIdToDelete = event.currentTarget.dataset.commentId;

                        showMessageBox("Are you sure you want to delete this comment?");
                        document.getElementById('messageBoxCloseBtn').onclick = async () => {
                            try {
                                const commentRef = doc(db, `artifacts/${appId}/public/data/proposals`, proposalId, 'comments', commentIdToDelete);
                                await deleteDoc(commentRef);
                                messageBox.classList.add('hidden');
                            } catch (e) {
                                console.error("Error deleting comment: ", e);
                                showMessageBox("Failed to delete comment. Please try again. Check Firebase rules for comments subcollection.");
                            }
                            document.getElementById('messageBoxCloseBtn').onclick = () => messageBox.classList.add('hidden');
                        };
                    };
                });
            }

            searchInput.addEventListener('input', () => {
                renderProposals(allProposals);
            });

            cancelEditBtn.addEventListener('click', () => {
                editModal.classList.add('hidden');
            });

            saveEditBtn.addEventListener('click', async () => {
                const proposalId = editProposalIdInput.value;
                const newTitle = editTitleInput.value.trim();
                const newDescription = editDescriptionInput.value.trim();
                const newLink = editLinkInput.value.trim();

                if (!newTitle || !newDescription) {
                    showMessageBox("Title and description cannot be empty.");
                    return;
                }

                try {
                    const proposalRef = doc(db, `artifacts/${appId}/public/data/proposals`, proposalId);
                    await updateDoc(proposalRef, {
                        title: newTitle,
                        description: newDescription,
                        link: newLink
                    });
                    editModal.classList.add('hidden');
                } catch (e) {
                    console.error("Error updating document: ", e);
                    showMessageBox("Failed to save changes. Please try again. Check Firebase rules for 'proposals' collection.");
                }
            });

            cancelEditCommentBtn.addEventListener('click', () => {
                editCommentModal.classList.add('hidden');
            });

            saveEditCommentBtn.addEventListener('click', async () => {
                const proposalId = editCommentProposalIdInput.value;
                const commentIdToEdit = editCommentIdInput.value;
                const newCommentText = editCommentTextInput.value.trim();

                if (!newCommentText) {
                    showMessageBox("Comment cannot be empty.");
                    return;
                }

                try {
                    const commentRef = doc(db, `artifacts/${appId}/public/data/proposals`, proposalId, 'comments', commentIdToEdit);
                    await updateDoc(commentRef, {
                        text: newCommentText
                    });
                    editCommentModal.classList.add('hidden');
                } catch (e) {
                    console.error("Error saving comment changes: ", e);
                    showMessageBox("Failed to save comment changes. Please try again. Check Firebase rules for comments subcollection.");
                }
            });
        }); // End of DOMContentLoaded
    </script>
</body>
</html>
